dist: bionic
language: php

php:
  - '7.3'

services:
  - mysql

before_install:
  - composer self-update
  - composer validate

install:
  - mysql -e 'CREATE DATABASE servidor_test;'
  - composer install --no-interaction
  - npm clean-install
  - cp .env.travis .env
  - php artisan key:generate
  - php artisan migrate && php artisan passport:install

before_script:
  - sudo chown -R www-data:www-data "$TRAVIS_BUILD_DIR/resources/test-skel"
  - sudo chown -R root:root "$TRAVIS_BUILD_DIR/resources/test-skel/protected"
  - sudo chmod 600 "$TRAVIS_BUILD_DIR/resources/test-skel/protected/forbidden"
  - npm run prod

script:
  - vendor/bin/php-cs-fixer fix --config=.php_cs.dist --verbose --diff --dry-run --using-cache=no
  - vendor/bin/phpcs app --standard=PSR12
  - vendor/bin/phpmnd . --non-zero-exit-on-violation --exclude tests
  - vendor/bin/phpunit

after_failure:
  - cat storage/logs/laravel.log

notifications:
  irc:
    channels:
      - "chat.freenode.net#servidor"
    on_success: change
    on_failure: always
    template:
      - "Build #%{build_number} (%{branch} @ %{commit} by %{author}) - %{message}"
      - "Details: %{build_url}"
